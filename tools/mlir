#!/bin/bash

set -e
pushd $(cd $(dirname ${0})/..; pwd) > /dev/null

entries=(
    "https://github.com/llvm/llvm-project.git|main|./third_party/source/llvm-project|mlir"
    "https://github.com/openxla/stablehlo.git|main|./third_party/source/stablehlo|"
    "https://github.com/onnx/onnx-mlir.git|main|./third_party/source/onnx-mlir|"
    "https://github.com/llvm/torch-mlir.git|main|./third_party/source/torch-mlir|"
    "https://github.com/tensorflow/mlir-hlo.git|main|./third_party/source/mlir-hlo|"
    "https://github.com/iree-org/iree.git|main|./third_party/source/iree|"
)

clean() {
    echo "mlir clean"
    for entry in "${entries[@]}"; do
        IFS='|' read -r url branch dir root <<< "${entry}"
        rm -rf "${dir}"
    done
}

sync() {
    echo "mlir sync"
    for entry in "${entries[@]}"; do
        IFS='|' read -r url branch dir root <<< "${entry}"
        if [ ! -d "${dir}" ]; then
            if [ -n "${root}" ]; then
                git clone --quiet --depth=1 --branch "${branch}" --single-branch --filter=blob:none --sparse "${url}" "${dir}"
                git -C "${dir}" sparse-checkout set "${root}"
            else
                git clone --quiet --depth=1 --branch "${branch}" --single-branch "${url}" "${dir}"
            fi
        else
            if [ -n "${root}" ]; then
                git -C "${dir}" sparse-checkout set "${root}"
            fi
            git -C "${dir}" fetch --quiet --depth=1 origin "${branch}"
            git -C "${dir}" reset --quiet --hard FETCH_HEAD
            git -C "${dir}" gc --quiet --prune=all
        fi
    done
    tensorflow_src_dir=./third_party/source/tensorflow
    if [ ! -d "${tensorflow_src_dir}" ]; then
        git clone --quiet --depth=1 --branch master --single-branch https://github.com/tensorflow/tensorflow.git "${tensorflow_src_dir}"
    else
        git -C "${tensorflow_src_dir}" fetch --quiet --depth=1 origin master
        git -C "${tensorflow_src_dir}" reset --quiet --hard FETCH_HEAD
        git -C "${tensorflow_src_dir}" gc --quiet --prune=all
    fi
}

schema() {
    echo "mlir schema"
    node ./tools/mlir_script.js
}

while [ "$#" != 0 ]; do
    command="$1" && shift
    case "${command}" in
        "clean") clean;;
        "sync") sync;;
        "schema") schema;;
    esac
done
